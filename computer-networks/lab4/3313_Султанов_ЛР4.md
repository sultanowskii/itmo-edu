# Лабораторная работа №4

Студент: `Султанов Артур Радикович`, группа: `P3313`

## Расшифровка HTTPS

[Расшифровка HTTPS-трафика Firefox на Linux в Wireshark с помощью `SSLKEYLOGFILE`](https://www.mohammedalani.com/tutorials/decrypting-encrypted-tls-traffic-using-wireshark-on-linux/)

```bash
$ SSLKEYLOGFILE="$HOME/firefox-keys.log" firefox &
$ ls -lah ~/firefox-keys.log
-rw-r--r-- 1 sultanowskii sultanowskii 9.1K May  2 11:52 /home/sultanowskii/firefox-keys.log
```

Записанный расшифрованный HTTP-трафик не прикладывается к материалам ЛР из соображений безопасности.

## Подготовка

Для сбора пакетов был выбран интерфейс `wlp0s20f3` - т.к. ноутбук подключен к Wi-Fi.

Целевым веб-сайтом был выбран [https://github.com/sultanowskii](https://github.com/sultanowskii) - мой Github-профиль.

## Анализ трафика утилиты `ping`

>`Ping` — утилита для проверки целостности и качества соединений в сетях на основе TCP/IP

Запустим ping. Сделаем это на 100, 128, 256, 512, 1024, 2048, 4096, 10000 байтах.

```bash
ping -c 5 -s 100 github.com
```

И заглянем в получившийся записанный траффик (с фильтром `(ip.dst_host == 140.82.112.4) || (ip.src_host == 140.82.112.4)`):

![ping](assets/img/ping.png)

Действительно, видны ICMP-запросы и ответы.

Пакет без фрагментации (`DON'T FRAGMENT`):

![no-frag](assets/img/ping-no-fragment.png)

Пакет с фрагментацией (`MORE FRAGMENTS`):

![frag](assets/img/ping-fragment.png)

Пакет с фрагментацией, который означает конец потока (не установлены флаги):

![frag](assets/img/ping-fragment2.png)

Итого, макс. размер ICMP без разбиения (опытным путем) - 1472 байта.

Зависимость кол-ва фрагментов от размера сообщения:

![diagram](assets/img/ping-size-fragments.png)

Изменить TTL можно параметром `-t`:

>`-t <ttl>           define time to live`

Пример:

```bash
$ ping -c 1 -t 2 -s 1470 github.com
PING github.com (140.82.121.3) 1470(1498) bytes of data.
From 10.40.86.1 icmp_seq=1 Time to live exceeded

--- github.com ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
```

В данных может лежать что угодно (главное, чтобы в ответ пришло ровно то, что отправлялось), но есть и определенные реализации, которые задают формат.

![ping data](assets/img/ping-data.png)

## Анализ трафика утилиты tracert (traceroute)

>`Traceroute` — служебная компьютерная программа, предназначенная для определения маршрутов следования данных в сетях TCP/IP.

Может использовать ICMP, TCP, UDP, GRE по своему усмотрению. Можно настроить.

[Принцип работы traceroute](https://networklessons.com/system-management/traceroute#Linux) - каждый раз, когда роутер пересылает сообщение дальше, он уменьшает TTL (в IP) на один. Соответственно, traceroute последовательно отправляет запросы со все растущим TTL. На первый запрос (`TTL=1`) вернет ответ 1 роутер с `TTL Exceeded`. Потом отправится второй пакет, с `TTL=2`, на который с `TTL Exceeded` ответит второй роутер и т.д. Делает он так по умолчанию 3 раза (3 попытки для каждого TTL) - потому и 3 колонки времени.

`* * *` в выводе означают, что на этом `TTL` он превысил время ожидания ответа - либо никто не ответил, либо роутер умеет распознавать такие "простуки".

Флаг `-n`:

>`-n   Do not resolve IP addresses to their domain names`

```bash
$ sudo traceroute -n github.com
traceroute to github.com (140.82.121.3), 30 hops max, 60 byte packets
 1  192.168.0.1  2.938 ms  2.912 ms  2.905 ms
 2  10.40.86.1  2.536 ms  2.529 ms  2.522 ms
 3  10.37.131.141  3.109 ms  3.102 ms  3.096 ms
 4  10.37.254.110  3.090 ms  3.084 ms  4.797 ms
 5  10.37.5.165  4.849 ms  4.843 ms  4.837 ms
 6  10.37.2.69  3.829 ms  3.144 ms  3.128 ms
 7  10.37.5.85  3.277 ms  2.921 ms  2.880 ms
 8  10.37.129.190  3.547 ms  3.470 ms  3.460 ms
 9  194.68.128.180  13.232 ms  13.210 ms  13.203 ms
10  94.103.180.71  34.187 ms  33.320 ms  33.444 ms
11  94.103.180.3  34.251 ms  34.244 ms  33.989 ms
12  94.103.180.2  33.981 ms  34.509 ms  34.500 ms
13  * * *
14  * * *
15  * * *
16  * * *
17  94.103.180.24  33.284 ms  33.272 ms  33.758 ms
18  45.153.82.37  33.823 ms  33.833 ms 45.153.82.39  33.804 ms
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
```

>A hop that outputs `* * *` means that the router at that hop doesn't respond to the type of packet you were using for the traceroute.

![traceroute TTL](assets/img/traceroute-ttl.png)

Как видно, у последующих запросов растет TTL - для того, чтобы "достать" до все более дальнего и дальнего роутера.

Основное отличие traceroute и ping с точки зрения ICMP - что у traceroute при каждой итерации увеличивается TTL.

Если убрать `-n`, то дополнительно будет идти DNS-трафик.

## Анализ HTTP-трафика

Записанный трафик:

![http](assets/img/http.png)

Первый запрос на страницу (записано 1279 сообщений):

![http first](assets/img/http-first.png)

Перезагрузка страницы происходит на пакете 1280. После перезагрузки было записано 1080 пакетов.

![http second](assets/img/http-second.png)

Если внимательно приглядеться к ответам в обоих случаях (и с другими файлами, css, js, ...), то можно заметить, что веб-сайт не прибегает к 304 и всегда отдает страницу как "новую" - 200. Это не очень эффективно и порождает немалое количество запросов на ресурсы, которые уже были получены клиентом ранее.

![http resp](assets/img/http-response.png)

## Анализ DNS-трафика

172.64.41.4 - Cloudflare, CDN. Прежде, чем "дать доступ" к Github, Cloudflare анализирует трафик и только потом "пропускает", давая IP-адрес и сетевой доступ.

![dns](assets/img/dns.png)

![dns resp](assets/img/dns-response.png)

Виды DNS-записей:

- `A`: IPv4-адрес
- `AAAA`: IPv6 адрес
- `CNAME`: форвардинг с поддомена/домена на поддомен (`mail.yandex.ru`)
- `MX`: направляет письмо на email-сервер
- `TXT`: произвольные текстовые заметки
- `SOA`: информация о поддомене
- `SRV`: указание порта для специфичных сервисов
- `NS`: указание NS-сервера, ответственного за определенное имя

## Анализ ARP-трафика

```bash
$ sudo arp -d 192.168.0.1
$
```

Как видно, при попытке "сходить в интернет", отсылается (от компьютера `192.168.0.106`) ARP-запрос (2) на поиск роутера `192.168.0.1`. После - роутер отвечает (`192.168.0.1`).

![arp](assets/img/arp.png)

ARP-запрос:

![arp req](assets/img/arp-request.png)

Он содержит адрес отправителя, чтобы за меньшее число операций у других участников сети появилась информация об этом устройстве. К тому же, если бы не было этого поля, то коммутатор просто не смог бы обучаться.

## Вывод

В данной лабораторной работе была произведена запись сетевого трафика с помощью утилиты Wireshark. Я записал трафик утилит ping, tracert, а также запросов в веб-браузере. Были на практике проанализированы протоколы ICMP, UDP, IP, DNS, HTTP, ARP.
